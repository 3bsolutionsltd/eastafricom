<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Health Check</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .status-item {
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }
        
        .status-item.success {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .status-item.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .status-item.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .status-item.loading {
            background: #e7f3ff;
            border-left-color: #007bff;
        }
        
        .status-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .status-value {
            font-size: 0.9rem;
            color: #666;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .details {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .summary {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .summary-label {
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• API Health Check</h1>
            <p>Monitor your backend API endpoints and database status</p>
        </div>
        
        <div class="card">
            <h2>Quick Actions</h2>
            <button onclick="runFullCheck()">Run Full Check</button>
            <button onclick="checkDatabase()">Database Only</button>
            <button onclick="checkAPIs()">APIs Only</button>
        </div>
        
        <div class="card">
            <h2>System Status</h2>
            <div class="status-grid" id="systemStatus">
                <div class="status-item loading">
                    <div class="status-label">Status</div>
                    <div class="status-value">Click "Run Full Check" to begin</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Database Diagnostics</h2>
            <div id="databaseResults">
                <p style="color: #666;">No data yet. Run a check to see results.</p>
            </div>
        </div>
        
        <div class="card">
            <h2>API Endpoints</h2>
            <div id="apiResults">
                <p style="color: #666;">No data yet. Run a check to see results.</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/backend/api';
        
        const endpoints = [
            { name: 'Diagnostics', path: 'diagnostics.php' },
            { name: 'Testimonials (All)', path: 'testimonials.php' },
            { name: 'Testimonials (Featured)', path: 'testimonials.php?featured=true&limit=10' },
            { name: 'Products', path: 'products.php' },
            { name: 'Contact Info', path: 'contact-info.php' },
            { name: 'Settings', path: 'settings.php' }
        ];
        
        async function runFullCheck() {
            updateSystemStatus('loading', 'Running full system check...');
            await checkDatabase();
            await checkAPIs();
            updateSystemStatus('success', 'Full check completed');
        }
        
        async function checkDatabase() {
            const resultsDiv = document.getElementById('databaseResults');
            resultsDiv.innerHTML = '<div class="spinner"></div> Checking database...';
            
            try {
                const response = await fetch(`${API_BASE}/diagnostics.php`);
                const data = await response.json();
                
                if (data.success) {
                    let html = '<div class="status-grid">';
                    
                    // Connection status
                    html += `
                        <div class="status-item ${data.database.connection === 'OK' ? 'success' : 'error'}">
                            <div class="status-label">Database Connection</div>
                            <div class="status-value">${data.database.connection}</div>
                        </div>
                    `;
                    
                    // Environment
                    html += `
                        <div class="status-item success">
                            <div class="status-label">Environment</div>
                            <div class="status-value">${data.database.environment}</div>
                        </div>
                    `;
                    
                    // Testimonials table
                    const testimonialsExists = data.tables?.testimonials_exists;
                    html += `
                        <div class="status-item ${testimonialsExists ? 'success' : 'error'}">
                            <div class="status-label">Testimonials Table</div>
                            <div class="status-value">${testimonialsExists ? 'EXISTS' : 'MISSING'}</div>
                        </div>
                    `;
                    
                    if (testimonialsExists) {
                        html += `
                            <div class="status-item success">
                                <div class="status-label">Total Records</div>
                                <div class="status-value">${data.tables.testimonials_count}</div>
                            </div>
                            <div class="status-item success">
                                <div class="status-label">Active Records</div>
                                <div class="status-value">${data.tables.testimonials_active_count}</div>
                            </div>
                            <div class="status-item success">
                                <div class="status-label">Featured Records</div>
                                <div class="status-value">${data.tables.testimonials_featured_count}</div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    
                    // Full details
                    html += '<div class="details">' + JSON.stringify(data, null, 2) + '</div>';
                    
                    resultsDiv.innerHTML = html;
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="status-item error">
                        <div class="status-label">Error</div>
                        <div class="status-value">${error.message}</div>
                    </div>
                `;
            }
        }
        
        async function checkAPIs() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<div class="spinner"></div> Checking API endpoints...';
            
            const results = await Promise.all(
                endpoints.map(endpoint => checkEndpoint(endpoint))
            );
            
            let html = '<div class="status-grid">';
            
            for (const result of results) {
                const statusClass = result.status === 'success' ? 'success' : 
                                  result.status === 'warning' ? 'warning' : 'error';
                
                html += `
                    <div class="status-item ${statusClass}">
                        <div class="status-label">${result.name}</div>
                        <div class="status-value">
                            ${result.statusCode} - ${result.message}
                            ${result.count !== undefined ? `<br>Count: ${result.count}` : ''}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            
            // Summary
            const successCount = results.filter(r => r.status === 'success').length;
            const errorCount = results.filter(r => r.status === 'error').length;
            const warningCount = results.filter(r => r.status === 'warning').length;
            
            html += `
                <div class="summary">
                    <div class="summary-item">
                        <div class="summary-number" style="color: #28a745;">${successCount}</div>
                        <div class="summary-label">Successful</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number" style="color: #ffc107;">${warningCount}</div>
                        <div class="summary-label">Warnings</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number" style="color: #dc3545;">${errorCount}</div>
                        <div class="summary-label">Errors</div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }
        
        async function checkEndpoint(endpoint) {
            try {
                const response = await fetch(`${API_BASE}/${endpoint.path}`);
                const data = await response.json();
                
                const result = {
                    name: endpoint.name,
                    path: endpoint.path,
                    statusCode: response.status
                };
                
                if (response.ok && data.success) {
                    result.status = 'success';
                    result.message = 'OK';
                    
                    // Extract count if available
                    if (data.data?.count !== undefined) {
                        result.count = data.data.count;
                    } else if (data.data?.testimonials?.length !== undefined) {
                        result.count = data.data.testimonials.length;
                    } else if (data.data?.products?.length !== undefined) {
                        result.count = data.data.products.length;
                    }
                } else if (response.ok && data.success === undefined) {
                    result.status = 'warning';
                    result.message = 'Response OK but no success flag';
                } else {
                    result.status = 'error';
                    result.message = data.message || 'Error';
                }
                
                return result;
            } catch (error) {
                return {
                    name: endpoint.name,
                    path: endpoint.path,
                    status: 'error',
                    statusCode: 0,
                    message: error.message
                };
            }
        }
        
        function updateSystemStatus(status, message) {
            const statusDiv = document.getElementById('systemStatus');
            const statusClass = status === 'success' ? 'success' : 
                              status === 'loading' ? 'loading' : 'error';
            
            statusDiv.innerHTML = `
                <div class="status-item ${statusClass}">
                    <div class="status-label">System Status</div>
                    <div class="status-value">${message}</div>
                </div>
            `;
        }
    </script>
</body>
</html>
